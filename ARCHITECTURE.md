# Архитектура Elenya Bot

## Общая схема работы

```
┌─────────────────┐
│   Пользователь  │
│    (Telegram)   │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────────────────┐
│            Telegram Bot API                  │
└────────┬────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────┐
│              bot.py (main)                   │
│  • Инициализация компонентов                 │
│  • Регистрация handlers                      │
│  • Запуск polling                            │
└────────┬────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────┐
│             HANDLERS                         │
│                                              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │  start   │  │   text   │  │  voice   │  │
│  │  /start  │  │  текст   │  │  голос   │  │
│  │  /mode   │  │          │  │          │  │
│  └──────────┘  └──────────┘  └──────────┘  │
│                                              │
│  ┌──────────┐  ┌──────────┐                 │
│  │  image   │  │ callback │                 │
│  │  фото    │  │  кнопки  │                 │
│  └──────────┘  └──────────┘                 │
└────────┬────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────┐
│              SERVICES                        │
│                                              │
│  ┌───────────────────┐  ┌────────────────┐  │
│  │  mode_manager.py  │  │   router.py    │  │
│  │                   │  │                │  │
│  │ • Словарь/        │  │ • Запросы к    │  │
│  │   Свободный       │  │   OpenAI       │  │
│  │ • Состояние       │  │ • Форматир.    │  │
│  │   пользователя    │  │   промптов     │  │
│  └───────────────────┘  └────────────────┘  │
└────────┬────────────────────────────────────┘
         │
         ├──────────────┬──────────────┬──────────────┐
         ▼              ▼              ▼              ▼
    ┌────────┐    ┌─────────┐   ┌─────────┐   ┌──────────┐
    │  RAG   │    │  Utils  │   │ OpenAI  │   │ OpenAI   │
    │        │    │         │   │   LLM   │   │  Vision  │
    │ loader │    │   STT   │   │ GPT-4   │   │          │
    │ query  │    │ Whisper │   │         │   │          │
    └────────┘    └─────────┘   └─────────┘   └──────────┘
         │
         ▼
    ┌──────────┐
    │ ChromaDB │
    │ Vector   │
    │   Store  │
    └──────────┘
```

## Потоки данных

### 1. Текстовое сообщение

```
Пользователь
    ↓ [текст: "звезда"]
Telegram API
    ↓
handlers/text.py
    ↓
services/mode_manager.py → [проверка режима]
    ↓
services/router.py
    ↓ [если режим словаря]
rag/query.py → [поиск в ChromaDB]
    ↓
services/router.py → [формирование промпта]
    ↓
OpenAI GPT-4 API
    ↓ [ответ]
handlers/text.py
    ↓
Telegram API → Пользователь
```

### 2. Голосовое сообщение

```
Пользователь
    ↓ [голос]
Telegram API
    ↓ [OGG файл]
handlers/voice.py
    ↓ [сохранение в /tmp]
utils/stt.py
    ↓
OpenAI Whisper API
    ↓ [распознанный текст]
handlers/voice.py → [далее как текст]
    ↓
services/router.py
    ↓
...
```

### 3. Изображение

```
Пользователь
    ↓ [фото]
Telegram API
    ↓ [JPG файл]
handlers/image.py
    ↓ [сохранение в /tmp]
utils/vision.py
    ↓
OpenAI Vision API
    ↓ [определенный объект]
handlers/image.py
    ↓
services/router.py → [перевод объекта]
    ↓
...
```

## Компоненты системы

### handlers/ (Обработчики)

**Ответственность:** Прием сообщений от пользователя

| Файл | Назначение |
|------|-----------|
| `start.py` | Приветствие, выбор режима, inline кнопки |
| `text.py` | Обработка текстовых сообщений |
| `voice.py` | Обработка голосовых сообщений |
| `image.py` | Обработка изображений |

### services/ (Бизнес-логика)

**Ответственность:** Управление состоянием и маршрутизация

| Файл | Назначение |
|------|-----------|
| `mode_manager.py` | Управление режимами работы (словарь/свободный) |
| `router.py` | Маршрутизация запросов к OpenAI, формирование промптов |

### utils/ (Утилиты)

**Ответственность:** Работа с внешними API

| Файл | Назначение |
|------|-----------|
| `stt.py` | Распознавание речи через Whisper |
| `vision.py` | Анализ изображений через Vision |

### rag/ (RAG система)

**Ответственность:** Работа со словарем

| Файл | Назначение |
|------|-----------|
| `loader.py` | Загрузка PDF-словаря в векторную БД |
| `query.py` | Поиск релевантной информации в словаре |

## Состояние и данные

### Состояние в памяти

```python
ModeManager.user_modes: Dict[chat_id, mode]
# Пример:
{
    123456: "dictionary",
    789012: "free"
}
```

### Векторная база данных

```
ChromaDB (в памяти)
├── collection: "elenya_dictionary"
├── embeddings: OpenAI embeddings
└── chunks: ~X фрагментов из PDF
```

### Временные файлы

```
/tmp/
├── voice_{chat_id}_{file_id}.ogg  # Голосовые сообщения
└── photo_{chat_id}_{file_id}.jpg  # Изображения

# Удаляются после обработки
```

## Конфигурация

### Переменные окружения (.env)

```env
TELEGRAM_TOKEN=<токен бота>
OPENAI_API_KEY=<ключ API>
```

### Константы (config.py)

```python
OPENAI_MODEL = "gpt-4-turbo"
DICTIONARY_PATH = os.path.join(PROJECT_ROOT, "rag", "data", "elenya_dict.pdf")
```

## Масштабирование и оптимизация

### Текущая реализация (MVP)

- ✅ Все в памяти
- ✅ Синхронная обработка
- ✅ Один экземпляр бота

### Возможные улучшения

1. **Персистентность:**
   - Redis для хранения режимов пользователей
   - PostgreSQL для истории переводов

2. **Производительность:**
   - Кэширование частых запросов
   - Пул соединений к API
   - Асинхронная обработка

3. **Отказоустойчивость:**
   - Retry логика для API запросов
   - Graceful shutdown
   - Health checks

4. **Мониторинг:**
   - Логирование в Elasticsearch
   - Метрики в Prometheus
   - Трейсинг запросов

## Безопасность

### Текущие меры

- ✅ Токены в `.env` (не в коде)
- ✅ `.gitignore` для секретов
- ✅ Удаление временных файлов
- ✅ Обработка исключений

### Рекомендации для продакшна

1. Ротация токенов
2. Rate limiting
3. Валидация входных данных
4. HTTPS для webhook (вместо polling)
5. Шифрование логов

## Зависимости между модулями

```
bot.py
├── → config.py
├── → handlers/*
│   ├── → services/mode_manager.py
│   ├── → services/router.py
│   ├── → utils/stt.py
│   └── → utils/vision.py
├── → services/router.py
│   └── → rag/query.py
└── → rag/loader.py
    └── → config.py
```

## Жизненный цикл бота

### Старт

```
1. Загрузка config.py → проверка .env
2. Инициализация RAG:
   - Загрузка PDF
   - Создание эмбеддингов
   - Индексация в ChromaDB
3. Создание сервисов:
   - ModeManager
   - Router
   - STT, Vision
4. Регистрация handlers
5. Запуск polling
6. ✅ Готов принимать сообщения
```

### Обработка сообщения

```
1. Получение update от Telegram
2. Диспетчеризация в соответствующий handler
3. Обработка через services
4. Вызов внешних API (если нужно)
5. Формирование ответа
6. Отправка пользователю
```

### Остановка

```
1. Ctrl+C → KeyboardInterrupt
2. Завершение polling
3. Cleanup (если есть)
4. Выход
```

---

Эта архитектура обеспечивает:
- ✅ Модульность
- ✅ Расширяемость
- ✅ Тестируемость
- ✅ Читаемость кода
- ✅ Легкость поддержки
